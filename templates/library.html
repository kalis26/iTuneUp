{% extends 'nav.html' %}

{% block title %}Library - iTuneUp{% endblock %}

{% block content %}

    <div class="library-container" data-albums="{{ albums|tojson|e }}" id="libraryContainer">

        {% if albums %}

            <div class="library-content">
                <div class="albums-grid" id="albumsGrid">
                    {% for album in albums %}
                        <div class="album-box" data-album-index="{{ loop.index0 }}" onclick="toggleAlbumDetails('{{ loop.index0 }}')">
                            <div class="album-cover">
                                <img src="{{ url_for('album_cover', album_folder=album.folder_name) }}" 
                                    alt="{{ album.album }}" 
                                    onerror="this.src='/static/images/default-cover.png'">
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="pagination-controls">
                <button class="page-btn" id="prevBtn" onclick="changePage(-1)">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M10 4L6 8L10 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                
                <div class="page-dots" id="pageDots">
                    <!-- Dots will be generated by JavaScript -->
                </div>
                
                <button class="page-btn" id="nextBtn" onclick="changePage(1)">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>

        {% else %}

            <div class="empty-library">
                <div class="empty-img">
                    <img src="{{ url_for('static', filename='images/default-cover.png') }}" alt="Empty Library" class="empty-cover">
                </div>
                <h2>Your library is empty</h2>
                <p>Start by searching and downloading your favorite albums</p>
                <div class="start-searching-btn-container">
                    <a href="{{ url_for('home') }}" class="start-searching-btn">Start Searching</a>
                </div>         
            </div>
            
        {% endif %}

    </div>

<script type="application/json" id="albums-data">{{ albums|tojson }}</script>

{% endblock %}

{% block scripts %}

<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script>  


let albums = [];
let albumsPerPage = 10;
let currentPage = 1;
let totalPages = 1;
let albumDetails = null;
let albumsPerRow = 5;
let currentOpenAlbumIndex = null;

function createAlbumDetails() {

        albumDetails = document.createElement('div');
        albumDetails.className = 'album-details';
        albumDetails.id = 'albumDetails';
        albumDetails.innerHTML = `
            <div class="details-content">
                <button class="close-details" onclick="closeAlbumDetails()">Ã—</button>
                <div class="details-info">
                    <div class="details-text">
                        <h2 id="detailsAlbum">Album Name</h2>
                        <div class="detailsBA">
                            <span id="detailsBy">By </span>
                            <span id="detailsArtist">Artist Name</span>
                        </div>
                        <div class="detailsYSG">
                            <span id="detailsGenre">Genre</span>
                            <span id="detailsSymbol">-</span>
                            <span id="detailsYear">Year</span>
                        </div>
                        <div class="details-meta">
                            <p id="detailsDate">Date</p>
                            <div class="detailsTM">
                                <span id="detailsTracks">0 tracks</span>
                                <span id="detailsComma">, </span>
                                <span id="detailsDuration">0 minutes</span>
                            </div>
                            <p id="detailsCopyright">Copyright</p>
                        </div>
                    </div>
                    <div class="details-tracks">
                        <ul id="detailsTrackList">
                            <li>No tracks available</li>
                        </ul>
                    </div>
                </div>
            </div>
        `;
}

function generatePageDots() {

    const dotsContainer = document.getElementById('pageDots');
    if (!dotsContainer) return;
    
    dotsContainer.innerHTML = '';
    
    if (totalPages > 1) {
        console.log(`Generating ${totalPages} dots`);
        for (let i = 1; i <= totalPages; i++) {
            const dot = document.createElement('div');
            dot.className = 'page-dot';
            dot.onclick = () => goToPage(i);
            dotsContainer.appendChild(dot);
        }
    } else {
        console.log('Only one page, no dots needed');
    }
}

function updatePagination() {

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const paginationControls = document.querySelector('.pagination-controls');
    const dots = document.querySelectorAll('.page-dot');

    if (totalPages <= 1) {
        if (paginationControls) {
            paginationControls.style.display = 'none';
        }
        return;
    } else {
        if (paginationControls) {
            paginationControls.style.display = 'flex';
        }
    }
    
    if (prevBtn) prevBtn.disabled = currentPage === 1;
    if (nextBtn) nextBtn.disabled = currentPage === totalPages;

    dots.forEach((dot, index) => {
        const pageNumber = index + 1;
        if (pageNumber === currentPage) {
            dot.classList.add('active');
        } else {
            dot.classList.remove('active');
        }
    });
    
    const albumBoxes = document.querySelectorAll('.album-box');
    albumBoxes.forEach((box, index) => {
        const startIndex = (currentPage - 1) * albumsPerPage;
        const endIndex = startIndex + albumsPerPage;
        
        if (index >= startIndex && index < endIndex) {
            box.style.display = 'block';
        } else {
            box.style.display = 'none';
        }
    });
}

function changePage(direction) {

    const newPage = currentPage + direction;
    if (newPage >= 1 && newPage <= totalPages) {

        const currentDot = document.querySelector('.page-dot.active');
        if (currentDot) {
            currentDot.classList.add('changing');
            setTimeout(() => currentDot.classList.remove('changing'), 400);
        }
        
        currentPage = newPage;
        updatePagination();
        closeAlbumDetails();
        
        setTimeout(() => {
            const newDot = document.querySelector('.page-dot.active');
            if (newDot) {
                newDot.classList.add('changing');
                setTimeout(() => newDot.classList.remove('changing'), 400);
            }
        }, 50);
    }
}

function goToPage(pageNumber) {
    if (pageNumber >= 1 && pageNumber <= totalPages && pageNumber !== currentPage) {

        const currentDot = document.querySelectorAll('.page-dot')[currentPage - 1];
        const targetDot = document.querySelectorAll('.page-dot')[pageNumber - 1];
        
        if (currentDot) {
            currentDot.classList.add('changing');
            setTimeout(() => currentDot.classList.remove('changing'), 400);
        }
        
        currentPage = pageNumber;
        updatePagination();
        closeAlbumDetails();
        
        if (targetDot) {
            targetDot.classList.add('changing');
            setTimeout(() => targetDot.classList.remove('changing'), 400);
        }
    }
}

function populateTrackList(tracklist) {

    const trackListElement = document.getElementById('detailsTrackList');
    if (!trackListElement || !tracklist || tracklist.length === 0) {
        if (trackListElement) {
            trackListElement.innerHTML = '<li>No tracks available</li>';
        }
        return;
    }

    const processedTracks = tracklist.map(track => {

        const match = track.match(/^(\d+)\s+(.+)$/);
        if (match) {
            return {
                number: parseInt(match[1], 10),
                title: match[2],
                original: track
            };
        } else {

            return {
                number: 999,
                title: cleanTrack,
                original: track
            };
        }
    });

    processedTracks.sort((a, b) => a.number - b.number);

    const trackHTML = processedTracks.map(track => {
        return `<li class="track-item">
            <span class="track-number">${track.number}</span>
            <span class="track-title">${track.title}</span>
        </li>`;
    }).join('');

    trackListElement.innerHTML = trackHTML;
}

function toggleAlbumDetails(albumIndex) {

    if (!albums || albums.length === 0) {
        console.error('Albums array not initialized');
        return;
    }

    const index = parseInt(albumIndex);

    if (currentOpenAlbumIndex === index && albumDetails && albumDetails.classList.contains('active')) {
        closeAlbumDetails();
        return;
    }

    const album = albums[index];

    if (!album) {
        console.error('Album not found at index:', index);
        return;
    }

    if (albumDetails && albumDetails.classList.contains('active')) {
        albumDetails.classList.remove('active');
        if (albumDetails.parentNode) {
            albumDetails.parentNode.removeChild(albumDetails);
        }
        albumDetails = null;
    }

    currentOpenAlbumIndex = index;

    createAlbumDetails();

    const albumBoxes = document.querySelectorAll('.album-box');
    const clickedBox = albumBoxes[index];
    
    if (!clickedBox) {
        console.error('Album box not found');
        return;
    }

    const startIndex = (currentPage - 1) * albumsPerPage;
    const relativeIndex = index - startIndex;
    const rowNumber = Math.floor(relativeIndex / albumsPerRow);

    const rowStartIndex = startIndex + (rowNumber * albumsPerRow);
    const rowEndIndex = Math.min(rowStartIndex + albumsPerRow - 1, startIndex + albumsPerPage - 1);
    
    let insertAfterBox = null;
    for (let i = rowEndIndex; i >= rowStartIndex; i--) {
        const box = albumBoxes[i];
        if (box && box.style.display !== 'none') {
            insertAfterBox = box;
            break;
        }
    }
    
    if (!insertAfterBox) {
        insertAfterBox = clickedBox;
    }

    try {
        insertAfterBox.insertAdjacentElement('afterend', albumDetails);
    } catch (error) {
        console.error('Failed to insert album details:', error);
        const albumsGrid = document.getElementById('albumsGrid');
        if (albumsGrid) {
            albumsGrid.appendChild(albumDetails);
        }
        return;
    }

    const detailsAlbum = document.getElementById('detailsAlbum');
    const detailsArtist = document.getElementById('detailsArtist');
    const detailsYear = document.getElementById('detailsYear');
    const detailsGenre = document.getElementById('detailsGenre');
    const detailsDate = document.getElementById('detailsDate');
    const detailsTracks = document.getElementById('detailsTracks');
    const detailsDuration = document.getElementById('detailsDuration');
    const detailsCopyright = document.getElementById('detailsCopyright');

    function getMonthName(monthIndex) {
        const months = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        return months[monthIndex];
    }

    function formatDate(dateString) {
        const components = dateString.split('-');
        if (components.length === 3) {
            const year = components[0];
            const month = getMonthName(parseInt(components[1], 10) - 1);
            const day = components[2];
            return `${month} ${day}, ${year}`;
        }
        return dateString;
    }

    if (detailsAlbum) detailsAlbum.textContent = album.album;
    if (detailsArtist) detailsArtist.textContent = album.artist;
    if (detailsYear) detailsYear.textContent = album.year.split('-')[0];
    if (detailsGenre) detailsGenre.textContent = album.genre;
    if (detailsDate) detailsDate.textContent = formatDate(album.year.split('T')[0]);
    if (detailsTracks) {
        if (album.track_count === 1) {
            detailsTracks.textContent = `${album.track_count} track`;
        } else {
            detailsTracks.textContent = `${album.track_count} tracks`;
        }
    }
    if (detailsDuration) detailsDuration.textContent = `${album.duration} minutes`;
    if (detailsCopyright) detailsCopyright.textContent = album.copyright;

    populateTrackList(album.track_list);

    setTimeout(() => {
        if (albumDetails && albumDetails.parentNode) {
            albumDetails.classList.add('active');
            
            setTimeout(() => {
                if (albumDetails && albumDetails.parentNode && albumDetails.getBoundingClientRect) {
                    const libraryContent = document.querySelector('.library-content');
                    if (libraryContent) {
                        const detailsRect = albumDetails.getBoundingClientRect();
                        const containerRect = libraryContent.getBoundingClientRect();
                        
                        if (detailsRect.bottom > containerRect.bottom - 100) {
                            albumDetails.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center',
                                inline: 'nearest' 
                            });
                        }
                    }
                }
            }, 100);
        }
    }, 50);
}

function closeAlbumDetails() {

    if (albumDetails && albumDetails.classList.contains('active')) {
        albumDetails.classList.remove('active');
        currentOpenAlbumIndex = null;
        
        setTimeout(() => {
            if (albumDetails && albumDetails.parentNode) {
                albumDetails.parentNode.removeChild(albumDetails);
            }
            albumDetails = null;
        }, 600);
    }
}

if (albums && albums.length > 0) {
    updatePagination();
}

</script>


{% endblock %}